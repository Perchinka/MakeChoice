# `src/infrastructure/`

Слой **Infrastructure** отвечает за все внешние взаимодействия приложения: работу с базой данных и интеграцию со сторонними сервисами (SSO в нашем случае). Он реализует абстракции из доменного слоя.

---

## Поддиректории

### `db/`  
Всё, что связано с базой данных (PostgreSQL + SQLAlchemy у нас):

- **`models.py`**  
  ORM-модели (`UserModel`, `CourseModel`, `ChoiceModel`), описывающие таблицы и связи.  
  Соответствуют Alembic-миграциям в `migrations/`.

- **`session.py`**  
  Создаёт фабрику сессий, позволяет просто и быстро подключаться к бд, особенно хорошо работает в unit_of_work, можешь глянуть там применение.  

- **`uow.py`**  
  Реализация паттерна **Unit of Work**:  
  1. В `__enter__` создаётся новая сессия и репозитории.  
  2. В `__exit__` — коммит или откат + закрытие сессии.  
  Гарантирует атомарность транзакций.

- **`repositories/`**  
  Конкретные реализации интерфейсов из `domain/repositories` на SQLAlchemy:  
  - `SqlAlchemyUserRepo`  
  - `SqlAlchemyCourseRepo`  
  - `SqlAlchemyChoiceRepo`  
  Преобразуют ORM-модели в доменные сущности (`User`, `Course`, `Choice`).

### `sso/`  
Ну тут сложно просто описать, почитай про, то как работает sso и oidc

- **`innopolis_oidc.py`**  
  Настройка Authlib OAuth-клиента для Innopolis SSO:  
  - Загружает `SSO_DISCOVERY_URL`, `CLIENT_ID`, `CLIENT_SECRET` из конфига.  
  - Регистрирует провайдер `innopolis_sso` в `oauth`.
Стырил из Innopoints-backend, надо будет поконсультироваться с разрабами, чьи контакты дали

---

## Зачем нужен Infrastructure

1. **Отделение реализации интерфейсов от домена**  
   Доменные сервисы и логика **не зависят** от конкретных технологий БД или SSO.

2. **Замена реализаций без переписывания логики**  
   При необходимости можно подключить другую БД, репозиторий или провайдера SSO, ничего не меняя в `domain/` и `services/`.

3. **Тестируемость**  
    Для юнит-тестов можно подменить UnitOfWork и репозитории на моки или in-memory реализации, но т.к. я ленивая жепка я не писал тесты :D

